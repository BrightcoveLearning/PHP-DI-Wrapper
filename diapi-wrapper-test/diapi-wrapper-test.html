<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>BCDIAPI Wrapper Test</title>
        <style>
          body {
              font-family: sans-serif;
              color: #333;
              padding: 4em;
              padding-top: 0;
          }
          fieldset {
              border-color: #559BB9;
              border-radius: 1em;
              font-size: small;
          }
          legend {
              color: #559BB9;
              text-align: center;
              font-weight: bold;
              font-size: 1.5em;
          }
          textarea.input {
              width: 100%;
              height: 6em;
          }
          textarea.output {
              width: 100%;
              height: 8em;
          }
          textarea.url {
              width: 100%;
              height: 3em;
          }
          button {
              padding: 1em;
          }
        </style>
    </head>
    <body>
    <h1>BCDIAPI Wrapper Test</h1>

    <div class="form-wrapper">
        <fieldset>
            <legend>Input</legend>
            <p>
                Request type:<br />
                <input type="radio" id="rPullVideo" name="requestType" value="pullNewVideo" checked="checked"><label for="rPullVideo"> New Video (pull-based)</label><br>
                <input type="radio" id="rPushVideo" name="requestType" value="pushNewVideo"><label for="rPushVideo"> New Video (sush-based)</label><br>
                <input type="radio" id="rPullReplaceVideo" name="requestType" value="pullReplaceVideo"><label for="rPullReplaceVideo"> Replace Video (pull-based)</label> | Video ID: <input type="text" id="pullReplaceVideoId" value=""><br>
                <input type="radio" id="rPushReplaceVideo" name="requestType" value="pushReplaceVideo"><label for="rPushReplaceVideo"> Replace Video (push-based)</label> | Video ID: <input type="text" id="pushReplaceVideoId" value=""><br>
                <input type="radio" id="rRetranscodeVideo" name="requestType" value="retrancodeVideo"><label for="rRetranscodeVideo"> Retranscode Video</label> | Video ID: <input type="text" id="retranscodeVideoId" value=""><br>
                <input type="radio" name="requestType" id="rAddMedia" value="addMedia"><label for="rAddMedia"> Add media for Video</label> | Video ID: <input type="text" id="addMediaVideoId" value=""><br>
            </p>
            
            <p>
                Poster Information (JSON: optional):<br />
<textarea class="input" id="posterdata">{
  "url": "http://solutions.brightcove.com/bcls/images/Great-Blue-Heron.png",
  "height": 360,
  "width": 640
}</textarea>
            </p>
            <p>
                Thumbnail Information (JSON: optional):<br />
<textarea class="input" id="thumbnaildata">{
  "url": "http://solutions.brightcove.com/bcls/images/great-blue-heron-thumbnail.png",
  "height": 90,
  "width": 160
}</textarea>
            </p>
            <p>
                Text Tracks Information (JSON: optional):<br />
<textarea class="input" id="texttracksdata">[
  {
    "url": "http://solutions.brightcove.com/bcls/assets/vtt/sample.vtt",
    "srclang": "en",
    "kind": "captions",
    "label": "EN",
    "default": true
  }
]</textarea>
            </p>
            <p>
                <button id="submit">Submit</button>
            </p>
        </fieldset>
    </div>
    <div>
        <fieldset>
            <legend>Output</legend>
            <p>
                CMS API request:<br />
                <textarea class="url" id="cmsRequest"></textarea>
            </p>
            <p>
                CMS API response:<br />
                <textarea class="output" id="cmsResponse"></textarea>
            </p>
            <p>
                DI API request:<br />
                <textarea class="url" id="diRequest"></textarea>
            </p>
            <p>
                DI API response:<br />
                <textarea class="output" id="diResponse"></textarea>
            </p>
        </fieldset>
    </div>
        <script>
        var BCLS = (function (window, document) {
            var requestURL = './diapi-wrapper-test.php',
                accountId = document.getElementById('accountId'),
                clientId = document.getElementById('clientId'),
                clientSecret = document.getElementById('clientSecret'),
                pullVideoSelect = document.getElementById('pullVideoSelect'),
                pushVideoSelect = document.getElementById('pushVideoSelect'),
                requestType = document.getElementsByName('requestType'),
                captureImages = document.getElementById('captureImages'),
                pullReplaceVideoId = document.getElementById('pullReplaceVideoId'),
                pushReplaceVideoId = document.getElementById('pushReplaceVideoId'),
                retranscodeVideoId = document.getElementById('retranscodeVideoId'),
                addMediaVideoId = document.getElementById('addMediaVideoId'),
                metadata = document.getElementById('metadata'),
                posterdata = document.getElementById('posterdata'),
                thumbnaildata = document.getElementById('thumbnaildata'),
                texttracksdata = document.getElementById('texttracksdata'),
                submit = document.getElementById('submit'),
                cmsRequest = document.getElementById('cmsRequest'),
                cmsResponse = document.getElementById('cmsResponse'),
                diRequest = document.getElementById('diRequest'),
                diResponse = document.getElementById('diResponse');

                /**
                 * tests for all the ways a variable might be undefined or not have a value
                 * @param {*} x the variable to test
                 * @return {Boolean} true if variable is defined and has a value
                 */
                function isDefined(x) {
                    if ( x === '' || x === null || x === undefined) {
                        return false;
                    }
                    return true;
                }

                /**
                 * get selected value for single select element
                 * @param {htmlElement} e the select element
                 * @return {Object} object containing the `value`, text, and selected `index`
                 */
                function getSelectValue(e) {
                    var selected = e.options[e.selectedIndex],
                        val = selected.value,
                        txt = selected.textContent,
                        idx = e.selectedIndex;
                    return {
                        value: val,
                        text: txt,
                        index: idx
                    };
                }

                /**
                * get value of a selected radio buttom
                * @param {htmlElementCollection} rgroup the collection of radio buttom elements
                */
                function getRadioValue(rgroup) {
                    var i = 0,
                    iMax = rgroup.length;
                    for (i; i < iMax; i++) {
                        if (rgroup[i].checked) {
                            return rgroup[i].value;
                        }
                    }
                }

                function requestCallback(response) {
                    console.log(JSON.parse(response));
                }

                /**
                 * @param  {Object} options for the request
                 * @param {Function} callback callback function
                 * @return {[type]}
                 */
                function sendRequest(options, callback) {
                    var httpRequest = new XMLHttpRequest(),
                        requestParams,
                        option,
                        // response handler
                        getResponse = function() {
                            try {
                              if (httpRequest.readyState === 4) {
                                if (httpRequest.status === 200) {
                                  console.log('response', httpRequest.responseText);
                                  callback(httpRequest.responseText);
                                } else {
                                  alert('There was a problem with the request. Request returned ' + httpRequest.status);
                                }
                              }
                            } catch (e) {
                              alert('Caught Exception: ' + e);
                            }
                        };
                    // set up request data
                    for (option in options) {
                        requestParams += option + '=' + options[option];
                    }
                    console.log('requestParams', requestParams);
                    // set response handler
                    httpRequest.onreadystatechange = getResponse;
                    // open the request
                    httpRequest.open('POST', requestURL);
                    // set headers
                    httpRequest.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                    // open and send request
                    httpRequest.send(requestParams);
                }

                pullVideoSelect.addEventListener('change', function() {
                    pushVideoSelect.setAttribute('disabled', 'disabled');
                });

                pushVideoSelect.addEventListener('change', function() {
                    pullVideoSelect.setAttribute('disabled', 'disabled');
                });

                captureImages.addEventListener('change', function() {
                    if (captureImages.checked) {
                        posterdata.value = '';
                        posterdata.setAttribute('disabled', 'disabled');
                        thumbnaildata.value = '';
                        thumbnaildata.setAttribute('disabled', 'disabled');
                    } else {
                        posterdata.removeAttribute('disabled', 'disabled');
                        thumbnaildata.removeAttribute('disabled', 'disabled');
                    }
                });

                submit.addEventListener('click', function() {
                    var selected,
                        options = {};
                    if (!isDefined(accountId.value) || !isDefined(clientId.value) || !isDefined(clientSecret.value)) {
                        alert('Account id, client id, and client secret are required - please enter values and try again');
                        return;
                    }
                    options.account_id = accountId.value;
                    options.client_id = clientId.value;
                    options.client_secret = clientSecret.value;
                    options.request_type = getRadioValue(requestType);
                    switch (options.request_type) {
                        case 'pullReplaceVideo':
                            if (isDefined(pullReplaceVideoId.value)) {
                                options.video_id = pullReplaceVideoId.value;
                            } else {
                                alert('You must supply a video id for request type to replace a video; please enter a video id and try again');
                                return;
                            }
                            break;
                        case 'pushReplaceVideo':
                            if (isDefined(pushReplaceVideoId.value)) {
                                options.video_id = pushReplaceVideoId.value;
                            } else {
                                alert('You must supply a video id for request type to replace a video; please enter a video id and try again');
                                return;
                            }
                            break;
                        case 'retranscodeVideo':
                            if (isDefined(retranscodeVideoId.value)) {
                                options.video_id = retranscodeVideoId.value;
                            } else {
                                alert('You must supply a video id for request type to retranscode a video; please enter a video id and try again');
                                return;
                            }
                            break;
                        case 'retranscodeVideo':
                            if (isDefined(retranscodeVideoId.value)) {
                                options.video_id = retranscodeVideoId.value;
                            } else {
                                alert('You must supply a video id for request type to retranscode a video; please enter a video id and try again');
                                return;
                            }
                            break;
                        default:
                            if (isDefined(getSelectValue(pullVideoSelect).value)) {
                            selected = getSelectValue(pullVideoSelect);
                            options.video_url = selected.value;
                            options.video_name = selected.text;
                        } else if (isDefined(getSelectValue(pushVideoSelect).value)) {
                            selected = getSelectValue(pushVideoSelect);
                            options.video_url = selected.value;
                            options.video_name = selected.text;
                        } else {
                            if (request_type === 'pullNewVideo' || request_type === 'pushNewVideo' || request_type === 'pullReplaceVideo' || request_type === 'pushReplaceVideo') {
                                alert ('You must select a video to pull or push for this request type; either change the request type or select a video and try again');
                                return;
                            }
                        }
                        break;
                    }
                    if (captureImages.checked) {
                        capture_images = true;
                    } else {
                        if (isDefined(posterdata.value)) {
                            options.poster = JSON.stringify(JSON.parse(posterdata.value));
                        }
                        if (isDefined(thumbnaildata.value)) {
                            options.thumbnail = JSON.stringify(JSON.parse(thumbnaildata.value));
                        }
                    }
                    if (isDefined(texttracksdata.value)) {
                        options.text_tracks = JSON.stringify(JSON.parse(texttracksdata.value));
                    }
                    console.log('options', options);
                    sendRequest(options, requestCallback);
                });
            })(window, document);
        </script>
    </body>
</html>
